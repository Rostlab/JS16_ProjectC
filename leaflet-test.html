<!DOCTYPE html>
<html>
<head>
	<title>Leaflet GOT Map</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="https://leafletjs-cdn.s3.amazonaws.com/content/leaflet/master/leaflet.css" />
	<script src="ASoIaF-overlays.js"></script>
	<style>
	.sealabel {
		font-family: "Lobster Two";
		font-weight: bold;
		color: #ccf;
		text-align: center;
	}
	
	.zoom0 .sealabel{
		font-size: 10px;
	}
	
	.zoom1 .sealabel{
		font-size: 20px;
	}
	
	.zoom2 .sealabel{
		font-size: 40px;
	}
	
	.zoom3 .sealabel{
		font-size: 80px;
	}
	
	.zoom4 .sealabel{
		font-size: 160px;
	}
	
	.zoom5 .sealabel{
		font-size: 320px;
		opacity: 0.5;
	}
	</style>
</head>
<body>
	<div id="map" style="position: absolute;left:0;right: 0;top:0;bottom: 0"></div>

	<script src="https://leafletjs-cdn.s3.amazonaws.com/content/leaflet/master/leaflet.js"></script>

	<script>
		var i = {
            defaultCoords: [0, 0],
            mapMinZoom: 0,
            mapMaxZoom: 5,
            mapPanDuration: 1,
            miniMapZoomLevel: 2.668,
            filtersCollection: {}
        };
        L.CRS.CustomZoom = L.extend({}, L.CRS.EPSG3857, {
            scale: function(e) {
                var t;
                switch (e) {
                case 4:
                    t = 2.166;
                    break;
                case 5:
                    t = 2.0915;
                    break;
                case i.miniMapZoomLevel:
                    t = 2;
                    break;
                default:
                    t = 2
                }
                return 256 * Math.pow(t, e)
            }
        });
        var n = {
            maxZoom: i.mapMaxZoom,
            minZoom: i.mapMinZoom,
            tapTolerance: 20,
            crs: L.CRS.CustomZoom,
            attributionControl: true
        };
        
		var map = L.map(document.getElementById('map'), n)
		var o = new L.LatLngBounds(map.unproject([0, 300], 1), map.unproject([500, 0], 1));
		
        map.options.mapBounds = o, map.fitBounds(o), map.setMaxBounds(o), map.off("movestart").on("movestart", function(e) {
            e.target.dragging._draggable && e.target.dragging._draggable.on("predrag", function() {
                var e = map.latLngToLayerPoint(map.options.maxBounds.getSouthWest()).add(this._newPos), t = map.latLngToLayerPoint(map.options.maxBounds.getNorthEast()).add(this._newPos), i = map.getSize();
                t.y > 0 && (this._newPos.y -= t.y / 1.2), e.x > 0 && (this._newPos.x -= e.x / 1.2), t.x < i.x && (this._newPos.x -= (t.x - i.x) / 1.2), e.y < i.y && (this._newPos.y -= (e.y - i.y) / 1.2)
            })
        });
        map.on('zoomanim', function (e) {
        	var el = document.getElementById('map');
        	if(el.className[el.className.length-2] != 'm') {
        		el.className += " zoom"+e.zoom;
        	} else {	
        		el.className = el.className.slice(0,-1) + e.zoom;
        	}
        });
        //var r = new L.tileLayer("http://viewers-guide.hbo.com/mapimages/{z}/y{y}x{x}.png", {
        var r = new L.tileLayer("https://raw.githubusercontent.com/Rostlab/JS16_ProjectC_Group10/develop/tiles/{z}/y{y}x{x}.png", {
            minZoom: i.mapMinZoom,
            maxZoom: i.mapMaxZoom,
            bounds: o,
            noWrap: true,
            attribution: 'Tiles &copy; HBO'
        });
        
        map.addLayer(r);
        
        var myIcon = L.divIcon({className: 'sealabel', html:'The&nbsp;Shivening&nbsp;Sea'});
        L.marker([80, -30], {icon: myIcon}).addTo(map);
        
        function onMapClick(e) {
            var marker = new L.marker(e.latlng, {draggable:'true'}).addTo(map);
            var position = e.latlng;
            marker.bindPopup(""+position).openPopup();
            marker.on('dragend', function(event){
                    var position = marker.getLatLng();
                    marker.unbindPopup().bindPopup(""+position).openPopup();
            });
        };
        map.on('click', onMapClick);
        
        
	    for(var name in locations) {
		    var el = locations[name];
        	var pos = [el.lat, el.lng];
        	pos[0]=43.0258+0.6388*pos[0]-0.0016*pos[0]*pos[0];
        	pos[1]=11.423+0.9072*pos[1]//-0.0016*pos[0]*pos[0];
        	new L.marker(pos).addTo(map).bindPopup('<h4>'+name+'</h4>'+pos);
	    };
	</script>
</body>
</html>

